# 🍪 Cookies 自动配置说明

## ✅ 功能已实现！

现在程序启动时会**自动检测和导出 cookies**，用户只需要点击一次授权即可。

---

## 🎯 工作原理

### 首次启动时：

1. **程序自动检测** cookies.txt 文件是否存在
2. **如果不存在**，自动尝试从浏览器导出
3. **弹出授权窗口**，提示用户点击「始终允许」
4. **自动保存** cookies到文件
5. **以后不再弹窗**

### 日志输出示例：

```
============================================================
🚀 视频笔记生成器正在启动...
============================================================

🍪 检查 Cookies 配置...
⚠️  未找到 cookies 文件
🔄 正在自动导出 cookies...
💡 首次运行需要授权访问浏览器 cookies
⚠️  请在弹出的授权窗口中点击「始终允许」

🔄 尝试从 CHROME 导出...
✅ Cookies 导出成功！
✅ Cookies 配置成功！

============================================================
✅ 应用启动完成！
🌐 访问: http://localhost:8001
============================================================
```

---

## 🚀 使用步骤

### 步骤 1: 启动程序

```bash
cd video_note_generator_v2
python web_app.py
```

### 步骤 2: 等待授权

- 程序会自动检测是否需要 cookies
- 如果是首次运行，会弹出授权窗口
- **重要**：点击「**始终允许**」（不是「允许」）

### 步骤 3: 自动完成

- Cookies 自动导出到 `cookies.txt`
- `.env` 文件自动更新
- 程序继续启动

### 步骤 4: 开始使用

- 刷新浏览器（如果已打开）
- 正常使用，不会再弹窗

---

## 🔧 技术实现

### 新增文件：

1. **src/video_note_generator/utils/cookie_manager.py**
   - CookieManager 类
   - 自动检测和导出 cookies
   - 支持多种浏览器（Chrome, Firefox, Edge, Safari）

2. **web_app.py（已更新）**
   - 添加启动事件处理器
   - 程序启动时自动调用 CookieManager

### 核心逻辑：

```python
@app.on_event("startup")
async def startup_event():
    cookie_manager = CookieManager(cookie_file="cookies.txt", logger=logger)

    if not cookie_manager.has_cookies():
        # 自动导出
        cookie_manager.auto_setup()
```

---

## 📋 常见场景

### 场景 1: 首次安装使用

```
用户：python web_app.py
程序：检测到没有 cookies，自动导出
系统：弹出授权窗口
用户：点击「始终允许」
程序：Cookies 导出成功，启动完成
```

### 场景 2: 已有 cookies

```
用户：python web_app.py
程序：检测到已有 cookies.txt
程序：直接启动，不弹窗
```

### 场景 3: Cookies 过期

```
用户：删除 cookies.txt
用户：python web_app.py
程序：检测到没有 cookies，重新导出
系统：弹出授权窗口（如果之前点了「始终允许」就不会弹）
程序：Cookies 导出成功
```

---

## ⚠️ 重要提示

### 授权窗口的正确操作：

❌ **错误**：点击「允许」
  - 每次运行都会弹窗

✅ **正确**：点击「始终允许」
  - 只需要授权一次
  - 以后不会再弹

### 支持的浏览器：

程序会按以下顺序尝试：
1. Chrome（推荐）
2. Edge
3. Firefox
4. Safari

### 失败处理：

如果自动导出失败：
- 程序会继续运行
- 显示警告信息
- 提供手动配置方法

---

## 🎉 优势

| 特性 | 旧方案 | 新方案 |
|------|--------|--------|
| 配置方式 | 手动运行脚本 | 自动检测导出 |
| 用户操作 | 需要运行额外命令 | 只需启动程序 |
| 授权次数 | 可能每次 | 只需一次 |
| 用户体验 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 📞 故障排除

### Q: 程序启动很慢？
A: 首次启动时可能需要等待 cookies 导出（30-60秒）

### Q: 授权窗口没有出现？
A: 可能浏览器没有登录，请先登录 YouTube

### Q: 所有浏览器都失败？
A: 使用手动导出方式：`python export_cookies.py`

---

**更新时间**: 2024-10-29
**版本**: v2.0

